<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>tea-tasting: a Python package for the statistical analysis of A/B tests | Evgeny Ivanov</title><link href=/favicon.svg rel=icon type=image/svg+xml><link href=/favicon.png rel=apple-touch-icon><link href=/favicon.ico rel=icon sizes=32x32><meta content="Advantages of using tea-tasting for the statistical analysis of experiments." name=description><meta content="Evgeny Ivanov" name=author><meta content="tea-tasting: a Python package for the statistical analysis of A/B tests" property=og:title><meta content="Advantages of using tea-tasting for the statistical analysis of experiments." property=og:description><meta content="Evgeny Ivanov" property=og:site_name><meta content=https://e10v.me/tea-tasting-analysis-of-experiments/ property=og:url><meta content=article property=og:type><meta content="Evgeny Ivanov" property=article:author><meta content=2024-07-29T00:00:00+00:00 property=article:published_time><meta content=2024-08-10T00:00:00+00:00 property=article:modified_time><meta content="a/b testing" property=article:tag><meta content=statistics property=article:tag><meta content=tea-tasting property=article:tag><meta content=python property=article:tag><meta content=/tea-tasting-analysis-of-experiments/tea-tasting.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=/tea-tasting-analysis-of-experiments/tea-tasting.png name=twitter:image><meta content="tea-tasting: a Python package for the statistical analysis of A/B tests" name=twitter:title><meta content="Advantages of using tea-tasting for the statistical analysis of experiments." name=twitter:description><meta content=@e10v_me name=twitter:site><meta content=@e10v_me name=twitter:creator><link href=https://e10v.me/tea-tasting-analysis-of-experiments/ rel=canonical><link title="Evgeny Ivanov" href=/atom.xml rel=alternate type=application/atom+xml><link title="Evgeny Ivanov" href=/rss.xml rel=alternate type=application/rss+xml><link crossorigin href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css integrity=sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB rel=stylesheet><link href=/giallo-dark.css id=syntax-highlight rel=stylesheet><link href=/css/style.css rel=stylesheet><script src=/js/color-modes.js></script><body><div class="container mb-5"><header><nav class="navbar navbar-expand-sm"><button aria-label="Toggle navigation" aria-controls=navbarSupportedContent aria-expanded=false class=navbar-toggler data-bs-target=#navbarSupportedContent data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto"><li class=nav-item><a class="nav-link ps-0" href=/>Posts</a><li class=nav-item><a class=nav-link href=/highlights>Highlights</a><li class=nav-item><a class=nav-link href=/tags>Tags</a><li class=nav-item><a class=nav-link href=/about>About</a></ul><hr class="d-sm-none my-2"><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://github.com/e10v target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>GitHub</title><use href=/icons.svg#github></use></svg> <span class="d-sm-none ms-1">GitHub</span> </a><li class=nav-item><a class=nav-link href=https://www.linkedin.com/in/evgenyivanov target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><use href=/icons.svg#linkedin></use></svg> <span class="d-sm-none ms-1">LinkedIn</span> </a><li class=nav-item><a class=nav-link href=https://t.me/e10v_me target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>Telegram</title><use href=/icons.svg#telegram></use></svg> <span class="d-sm-none ms-1">Telegram</span> </a><li class="nav-item pt-2 pb-1"><div class="vr d-none d-sm-flex h-100 mx-2"></div> <hr class="d-sm-none my-2"><li class="nav-item dropdown"><button aria-label="Toggle theme (auto)" class="nav-link dropdown-toggle pe-0" aria-expanded=false data-bs-display=static data-bs-toggle=dropdown id=bd-theme type=button><svg class="bi theme-icon-active" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#circle-half></use></svg> <span class="d-sm-none ms-1" id=bd-theme-text>Theme</span></button> <ul class="dropdown-menu dropdown-menu-end" aria-labelledby=bd-theme-text><li><button class="dropdown-item d-flex align-items-center" aria-pressed=true data-bs-theme-value=auto type=button><svg class="bi me-2 theme-icon" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#circle-half></use></svg> Auto <svg class="bi ms-auto d-none" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#check2></use></svg></button><li><button class="dropdown-item d-flex align-items-center" aria-pressed=false data-bs-theme-value=light type=button><svg class="bi me-2 theme-icon" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#sun-fill></use></svg> Light <svg class="bi ms-auto d-none" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#check2></use></svg></button><li><button class="dropdown-item d-flex align-items-center" aria-pressed=false data-bs-theme-value=dark type=button><svg class="bi me-2 theme-icon" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#moon-stars-fill></use></svg> Dark <svg class="bi ms-auto d-none" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#check2></use></svg></button></ul></ul></div></nav></header><main><article><h1 class=mb-4>tea-tasting: a Python package for the statistical analysis of A/B tests</h1><p class="mb-3 tag"><small class="text-secondary me-1"><time datetime=2024-07-29T00:00:00+00:00>Jul 29, 2024</time></small> <small><a class="bg-body-secondary py-1 px-2 rounded-2" href=https://e10v.me/tags/a-b-testing/>a/b testing</a></small> <small><a class="bg-body-secondary py-1 px-2 rounded-2" href=https://e10v.me/tags/statistics/>statistics</a></small> <small><a class="bg-body-secondary py-1 px-2 rounded-2" href=https://e10v.me/tags/tea-tasting/>tea-tasting</a></small> <small><a class="bg-body-secondary py-1 px-2 rounded-2" href=https://e10v.me/tags/python/>python</a></small><h2 class=h2 id=intro>Intro <a aria-label="Anchor link for: intro" class=anchor-link href=#intro>#</a></h2><p>I developed tea-tasting, a Python package for the statistical analysis of A/B tests featuring:<ul><li>Student's t-test, Bootstrap, variance reduction with CUPED, power analysis, and other statistical methods and approaches out of the box.<li>Support for a wide range of data backends, such as BigQuery, ClickHouse, PostgreSQL/GreenPlum, Snowflake, Spark, Pandas, and 20+ other backends supported by <a rel="noopener external" href=https://ibis-project.org/ target=_blank>Ibis</a>.<li>Extensible API: define custom metrics and use statistical tests of your choice.<li>Convenient API for reducing manual work, and a framework for minimizing errors.<li>Detailed documentation.</ul><p>In this blog post, I explore each of these advantages of using tea-tasting in the analysis of experiments.<p>If you are eager to try it, check the <a rel="noopener external" href=https://tea-tasting.e10v.me/ target=_blank>documentation</a>.<h2 class=h2 id=statistical-methods>Statistical methods <a aria-label="Anchor link for: statistical-methods" class=anchor-link href=#statistical-methods>#</a></h2><p>tea-tasting includes statistical methods and techniques that cover most of what you might need in the analysis of experiments.<p>Analyze metric averages and proportions with the Student's t-test and the Z-test. Or use Bootstrap to analyze any other statistic of your choice. There is also a predefined method for analyzing quantiles with Bootstrap. tea-tasting also detects mismatches in the sample ratios of different variants of an A/B test.<p>tea-tasting applies the <a rel="noopener external" href=https://alexdeng.github.io/public/files/kdd2018-dm.pdf target=_blank>delta method</a> for the analysis of ratios of averages. For example, the average number of orders per average number of sessions, assuming that sessions are not randomization units.<p>Use pre-experiment data, metric forecasts, or other covariates to reduce variance and increase the sensitivity of an experiment. This approach is also known as <a rel="noopener external" href=https://exp-platform.com/Documents/2013-02-CUPED-ImprovingSensitivityOfControlledExperiments.pdf target=_blank>CUPED</a> or <a rel="noopener external" href=https://doordash.engineering/2020/06/08/improving-experimental-power-through-control-using-predictions-as-covariate-cupac/ target=_blank>CUPAC</a>.<p>The calculation of confidence intervals for <em>percentage</em> change in Student's t-test and Z-test can be tricky. Just taking the confidence interval for <em>absolute</em> change and dividing it by the control average will produce a biased result. tea-tasting applies the <a rel="noopener external" href=https://alexdeng.github.io/public/files/kdd2018-dm.pdf target=_blank>delta method</a> to calculate the correct interval.<p>Analyze statistical power for Student's t-test and Z-test. There are three possible options:<ul><li>Calculate the effect size, given statistical power and the total number of observations.<li>Calculate the total number of observations, given statistical power and the effect size.<li>Calculate statistical power, given the effect size and the total number of observations.</ul><p>Learn more in the detailed <a rel="noopener external" href=https://tea-tasting.e10v.me/user-guide/ target=_blank>user guide</a>.<p>The roadmap includes:<ul><li>Multiple hypotheses testing: <ul><li>Family-wise error rate: Holm–Bonferroni method.<li>False discovery rate: Benjamini–Hochberg procedure.</ul><li>A/A tests and simulations to analyze power of any statistical test.<li>More statistical tests: <ul><li>Asymptotic and exact tests for frequency data.<li>Mann–Whitney U test.</ul><li>Sequential testing: always valid p-value with mSPRT.</ul><p>You can define a <a rel="noopener external" href=https://tea-tasting.e10v.me/custom-metrics/ target=_blank>custom metric</a> with a statistical test of your choice.<h2 class=h2 id=data-backends>Data backends <a aria-label="Anchor link for: data-backends" class=anchor-link href=#data-backends>#</a></h2><p>There are many different databases and engines for storing and processing experimental data. And in most cases it's not efficient to pull the detailed experimental data into a Python environment. Many statistical tests, such as the Student's t-test or the Z-test, require only aggregated data for analysis.<p>For example, if the raw experimental data are stored in ClickHouse, it's faster and more efficient to calculate counts, averages, variances, and covariances directly in ClickHouse rather than fetching granular data and performing aggregations in a Python environment.<p>Querying all the required statistics manually can be a daunting and error-prone task. For example, analysis of ratio metrics and variance reduction with CUPED require not only the number of rows and variance, but also covariances. But don't worry: tea-tasting does all this work for you.<p>tea-tasting accepts data either as a Pandas DataFrame or an Ibis Table. <a rel="noopener external" href=https://ibis-project.org/ target=_blank>Ibis</a> is a Python package which serves as a DataFrame API to various data backends. It supports 20+ backends including BigQuery, ClickHouse, PostgreSQL/GreenPlum, Snowflake, and Spark. You can write an SQL query, <a rel="noopener external" href=https://ibis-project.org/how-to/extending/sql#backend.sql target=_blank>wrap</a> it as an Ibis Table, and pass it to tea-tasting.<p>Keep in mind that tea-tasting assumes that:<ul><li>Data is grouped by randomization units, such as individual users.<li>There is a column indicating the variant of the A/B test (typically labeled as A, B, etc.).<li>All necessary columns for metric calculations (like the number of orders, revenue, etc.) are included in the table.</ul><p>Some statistical methods, like Bootstrap, require granular data for the analysis. In this case, tea-tasting fetches the detailed data as well.<p>Learn more in the guide on <a rel="noopener external" href=https://tea-tasting.e10v.me/data-backends/ target=_blank>data backends</a>.<h2 class=h2 id=convenient-api>Convenient API <a aria-label="Anchor link for: convenient-api" class=anchor-link href=#convenient-api>#</a></h2><p>You can perform all the tasks listed above using just NumPy, SciPy, and Ibis. In fact, tea-tasting uses these packages under the hood. What tea-tasting offers on top is a convenient higher-level API.<p>It's easier to show than to describe. Here is the basic example:<pre class="giallo z-code"><code data-lang=python><span class=giallo-l><span class="z-keyword z-control">import</span><span> tea_tasting</span><span class="z-keyword z-control"> as</span><span> tt</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span>data</span><span class="z-keyword z-operator z-keyword z-operator z-assignment"> =</span><span> tt</span><span class="z-punctuation z-separator z-period z-python">.</span><span class="z-meta z-function-call z-generic z-python">make_users_data</span><span class="z-punctuation z-definition z-arguments z-begin z-python">(</span><span class="z-variable z-parameter z-variable">seed</span><span class="z-keyword z-operator z-keyword z-operator z-assignment">=</span><span class="z-constant z-numeric">42</span><span class="z-punctuation z-definition z-arguments z-end z-python">)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>experiment</span><span class="z-keyword z-operator z-keyword z-operator z-assignment"> =</span><span> tt</span><span class="z-punctuation z-separator z-period z-python">.</span><span class="z-meta z-function-call z-generic z-python">Experiment</span><span class="z-punctuation z-definition z-arguments z-begin z-python">(</span></span>
<span class=giallo-l><span class="z-variable z-parameter z-variable">    sessions_per_user</span><span class="z-keyword z-operator z-keyword z-operator z-assignment">=</span><span>tt</span><span class="z-punctuation z-separator z-period z-python">.</span><span class="z-meta z-function-call z-generic z-python">Mean</span><span class="z-punctuation z-definition z-arguments z-begin z-python">(</span><span class=z-string>"</span><span class=z-string>sessions</span><span class=z-string>"</span><span class="z-punctuation z-definition z-arguments z-end z-python">)</span><span class="z-punctuation z-separator z-arguments z-python">,</span></span>
<span class=giallo-l><span class="z-variable z-parameter z-variable">    orders_per_session</span><span class="z-keyword z-operator z-keyword z-operator z-assignment">=</span><span>tt</span><span class="z-punctuation z-separator z-period z-python">.</span><span class="z-meta z-function-call z-generic z-python">RatioOfMeans</span><span class="z-punctuation z-definition z-arguments z-begin z-python">(</span><span class=z-string>"</span><span class=z-string>orders</span><span class=z-string>"</span><span class="z-punctuation z-separator z-arguments z-python">,</span><span class=z-string> "</span><span class=z-string>sessions</span><span class=z-string>"</span><span class="z-punctuation z-definition z-arguments z-end z-python">)</span><span class="z-punctuation z-separator z-arguments z-python">,</span></span>
<span class=giallo-l><span class="z-variable z-parameter z-variable">    orders_per_user</span><span class="z-keyword z-operator z-keyword z-operator z-assignment">=</span><span>tt</span><span class="z-punctuation z-separator z-period z-python">.</span><span class="z-meta z-function-call z-generic z-python">Mean</span><span class="z-punctuation z-definition z-arguments z-begin z-python">(</span><span class=z-string>"</span><span class=z-string>orders</span><span class=z-string>"</span><span class="z-punctuation z-definition z-arguments z-end z-python">)</span><span class="z-punctuation z-separator z-arguments z-python">,</span></span>
<span class=giallo-l><span class="z-variable z-parameter z-variable">    revenue_per_user</span><span class="z-keyword z-operator z-keyword z-operator z-assignment">=</span><span>tt</span><span class="z-punctuation z-separator z-period z-python">.</span><span class="z-meta z-function-call z-generic z-python">Mean</span><span class="z-punctuation z-definition z-arguments z-begin z-python">(</span><span class=z-string>"</span><span class=z-string>revenue</span><span class=z-string>"</span><span class="z-punctuation z-definition z-arguments z-end z-python">)</span><span class="z-punctuation z-separator z-arguments z-python">,</span></span>
<span class=giallo-l><span class="z-punctuation z-definition z-arguments z-end z-python">)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>result</span><span class="z-keyword z-operator z-keyword z-operator z-assignment"> =</span><span> experiment</span><span class="z-punctuation z-separator z-period z-python">.</span><span class="z-meta z-function-call z-generic z-python">analyze</span><span class="z-punctuation z-definition z-arguments z-begin z-python">(</span><span>data</span><span class="z-punctuation z-definition z-arguments z-end z-python">)</span></span>
<span class=giallo-l><span class="z-support z-function">print</span><span class="z-punctuation z-definition z-arguments z-begin z-python">(</span><span>result</span><span class="z-punctuation z-definition z-arguments z-end z-python">)</span></span>
<span class=giallo-l><span class="z-punctuation z-definition z-comment">#</span><span class=z-comment>>             metric control treatment rel_effect_size rel_effect_size_ci pvalue</span></span>
<span class=giallo-l><span class="z-punctuation z-definition z-comment">#</span><span class=z-comment>>  sessions_per_user    2.00      1.98          -0.66%      [-3.7%, 2.5%]  0.674</span></span>
<span class=giallo-l><span class="z-punctuation z-definition z-comment">#</span><span class=z-comment>> orders_per_session   0.266     0.289            8.8%      [-0.89%, 19%] 0.0762</span></span>
<span class=giallo-l><span class="z-punctuation z-definition z-comment">#</span><span class=z-comment>>    orders_per_user   0.530     0.573            8.0%       [-2.0%, 19%]  0.118</span></span>
<span class=giallo-l><span class="z-punctuation z-definition z-comment">#</span><span class=z-comment>>   revenue_per_user    5.24      5.73            9.3%       [-2.4%, 22%]  0.123</span></span></code></pre><p>The two-stage approach, with separate parametrization and inference, is common in statistical modeling. This separation helps in making the code more modular and easier to understand.<p>tea-tasting performs calculations that can be tricky and error-prone:<ul><li>Analysis of ratio metrics with delta method.<li>Variance reduction with CUPED/CUPAC (also in combination with the delta method for ratio metrics).<li>Calculation of confidence intervals for both absolute and percentage change.<li>Analysis of statistical power.</ul><p>It also provides a framework for representing experimental data to avoid errors. Grouping the data by randomization units and including all units in the dataset is important for correct analysis.<p>In addition, tea-tasting provides some convenience methods and functions, such as pretty formatting of the result and a context manager for metric parameters.<h2 class=h2 id=documentation>Documentation <a aria-label="Anchor link for: documentation" class=anchor-link href=#documentation>#</a></h2><p>Last but not least: documentation. I believe that good documentation is crucial for tool adoption. That's why I wrote several user guides and an API reference.<p>I recommend starting with the example of basic usage in the <a rel="noopener external" href=https://tea-tasting.e10v.me/user-guide/ target=_blank>user guide</a>. Then you can explore specific topics, such as variance reduction or power analysis, in the same guide.<p>See the guide on <a rel="noopener external" href=https://tea-tasting.e10v.me/data-backends/ target=_blank>data backends</a> to learn how to use a data backend of your choice with tea-tasting.<p>See the guide on <a rel="noopener external" href=https://tea-tasting.e10v.me/custom-metrics/ target=_blank>custom metrics</a> if you want to perform a statistical test that is not included in tea-tasting.<p>Use the <a rel="noopener external" href=https://tea-tasting.e10v.me/api/ target=_blank>API reference</a> to explore all parameters and detailed information about the functions, classes, and methods available in tea-tasting.<h2 class=h2 id=conclusions>Conclusions <a aria-label="Anchor link for: conclusions" class=anchor-link href=#conclusions>#</a></h2><p>There are a variety of statistical methods that can be applied in the analysis of an experiment. But only a handful of them are actually used in most cases.<p>On the other hand, there are methods specific to the analysis of A/B tests that are not included in the general purpose statistical packages like SciPy.<p>tea-tasting's functionality includes the most important statistical tests, as well as methods specific to the analysis of A/B tests.<p>tea-tasting provides a convenient API that helps to reduce the time spent on analysis and minimize the probability of error.<p>In addition, tea-tasting optimizes computational efficiency by calculating the statistics in the data backend of your choice, where the data are stored.<p>With the detailed <a rel="noopener external" href=https://tea-tasting.e10v.me/ target=_blank>documentation</a>, you can quickly learn how to use tea-tasting for the analysis of your experiments.<h2 class=h2 id=p-s-package-name>P.S. Package name <a aria-label="Anchor link for: p-s-package-name" class=anchor-link href=#p-s-package-name>#</a></h2><p>The package name "tea-tasting" is a play on words that refers to two subjects:<ul><li><a rel="noopener external" href=https://en.wikipedia.org/wiki/Lady_tasting_tea target=_blank>Lady tasting tea</a> is a famous experiment which was devised by Ronald Fisher. In this experiment, Fisher developed the null hypothesis significance testing framework to analyze a lady's claim that she could discern whether the tea or the milk was added first to the cup.<li>"tea-tasting" phonetically resembles "t-testing" or Student's t-test, a statistical test developed by William Gosset.</ul><p class=my-4>© Evgeny Ivanov 2024</article></main><footer><p class=my-4>Follow me on:<a class="link-body-emphasis ms-2" href=https://www.linkedin.com/in/evgenyivanov target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><use href=/icons.svg#linkedin></use></svg> <span class=d-sm-none>LinkedIn</span> </a><a class="link-body-emphasis ms-2" href=https://x.com/e10v_me target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>X (Twitter)</title><use href=/icons.svg#twitter-x></use></svg> <span class=d-sm-none>X (Twitter)</span> </a><a class="link-body-emphasis ms-2" href=https://bsky.app/profile/e10v.me target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>Bluesky</title><use href=/icons.svg#bluesky></use></svg> <span class=d-sm-none>Bluesky</span> </a><a class="link-body-emphasis ms-2" href=https://t.me/e10v_me target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>Telegram</title><use href=/icons.svg#telegram></use></svg> <span class=d-sm-none>Telegram</span> </a><a class="link-body-emphasis ms-2" href=/atom.xml target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>Atom</title><use href=/icons.svg#rss-fill></use></svg> <span class=d-sm-none>Atom</span> </a></footer><div id=comments><script async crossorigin data-category=Announcements data-category-id=DIC_kwDOKD9-Dc4CmKHr data-emit-metadata=0 data-input-position=bottom data-lang=en data-mapping=title data-reactions-enabled=1 data-repo=e10v/e10v.github.io data-repo-id=R_kgDOKD9-DQ data-strict=1 data-theme=preferred_color_scheme src=https://giscus.app/client.js></script></div></div><script crossorigin integrity=sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js></script>
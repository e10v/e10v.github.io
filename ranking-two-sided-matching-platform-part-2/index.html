<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Ranking in a two-sided matching platform (Part 2) | Evgeny Ivanov</title><link href=/favicon.svg rel=icon type=image/svg+xml><link href=/favicon.png rel=apple-touch-icon><link href=/favicon.ico rel=icon sizes=32x32><meta content="A discrete choice model for ranking by the uplift in the probability of a deal in a services marketplace." name=description><meta content="Evgeny Ivanov" name=author><meta content="Ranking in a two-sided matching platform (Part 2)" property=og:title><meta content="A discrete choice model for ranking by the uplift in the probability of a deal in a services marketplace." property=og:description><meta content="Evgeny Ivanov" property=og:site_name><meta content=https://e10v.me/ranking-two-sided-matching-platform-part-2/ property=og:url><meta content=article property=og:type><meta content="Evgeny Ivanov" property=article:author><meta content=2023-08-28T00:00:00+00:00 property=article:published_time><meta content=2023-08-28T00:00:00+00:00 property=article:modified_time><meta content="learning to rank" property=article:tag><meta content="uplift modelling" property=article:tag><meta content="choice modelling" property=article:tag><meta content="matching market" property=article:tag><meta content=/ranking-two-sided-matching-platform-part-2/uplift_formula.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=/ranking-two-sided-matching-platform-part-2/uplift_formula.png name=twitter:image><meta content="Ranking in a two-sided matching platform (Part 2)" name=twitter:title><meta content="A discrete choice model for ranking by the uplift in the probability of a deal in a services marketplace." name=twitter:description><meta content=@e10v_me name=twitter:site><meta content=@e10v_me name=twitter:creator><link href=https://e10v.me/ranking-two-sided-matching-platform-part-2/ rel=canonical><link title="Evgeny Ivanov" href=/atom.xml rel=alternate type=application/atom+xml><link title="Evgeny Ivanov" href=/rss.xml rel=alternate type=application/rss+xml><link crossorigin href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css integrity=sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB rel=stylesheet><link href=/giallo-dark.css id=syntax-highlight rel=stylesheet><link href=/css/style.css rel=stylesheet><script src=/js/color-modes.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/katex.min.css integrity=sha384-Wsr4Nh3yrvMf2KCebJchRJoVo1gTU6kcP05uRSh5NV3sj9+a8IomuJoQzf3sMq4T rel=stylesheet><body><div class="container mb-5"><header><nav class="navbar navbar-expand-sm"><button aria-label="Toggle navigation" aria-controls=navbarSupportedContent aria-expanded=false class=navbar-toggler data-bs-target=#navbarSupportedContent data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto"><li class=nav-item><a class="nav-link ps-0" href=/>Posts</a><li class=nav-item><a class=nav-link href=/highlights>Highlights</a><li class=nav-item><a class=nav-link href=/tags>Tags</a><li class=nav-item><a class=nav-link href=/about>About</a></ul><hr class="d-sm-none my-2"><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://github.com/e10v target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>GitHub</title><use href=/icons.svg#github></use></svg> <span class="d-sm-none ms-1">GitHub</span> </a><li class=nav-item><a class=nav-link href=https://www.linkedin.com/in/evgenyivanov target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><use href=/icons.svg#linkedin></use></svg> <span class="d-sm-none ms-1">LinkedIn</span> </a><li class=nav-item><a class=nav-link href=https://t.me/e10v_me target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>Telegram</title><use href=/icons.svg#telegram></use></svg> <span class="d-sm-none ms-1">Telegram</span> </a><li class="nav-item pt-2 pb-1"><div class="vr d-none d-sm-flex h-100 mx-2"></div> <hr class="d-sm-none my-2"><li class="nav-item dropdown"><button aria-label="Toggle theme (auto)" class="nav-link dropdown-toggle pe-0" aria-expanded=false data-bs-display=static data-bs-toggle=dropdown id=bd-theme type=button><svg class="bi theme-icon-active" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#circle-half></use></svg> <span class="d-sm-none ms-1" id=bd-theme-text>Theme</span></button> <ul class="dropdown-menu dropdown-menu-end" aria-labelledby=bd-theme-text><li><button class="dropdown-item d-flex align-items-center" aria-pressed=true data-bs-theme-value=auto type=button><svg class="bi me-2 theme-icon" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#circle-half></use></svg> Auto <svg class="bi ms-auto d-none" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#check2></use></svg></button><li><button class="dropdown-item d-flex align-items-center" aria-pressed=false data-bs-theme-value=light type=button><svg class="bi me-2 theme-icon" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#sun-fill></use></svg> Light <svg class="bi ms-auto d-none" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#check2></use></svg></button><li><button class="dropdown-item d-flex align-items-center" aria-pressed=false data-bs-theme-value=dark type=button><svg class="bi me-2 theme-icon" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#moon-stars-fill></use></svg> Dark <svg class="bi ms-auto d-none" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=/icons.svg#check2></use></svg></button></ul></ul></div></nav></header><main><article><h1 class=mb-4>Ranking in a two-sided matching platform (Part 2)</h1><p class="mb-3 tag"><small class="text-secondary me-1"><time datetime=2023-08-28T00:00:00+00:00>Aug 28, 2023</time></small> <small><a class="bg-body-secondary py-1 px-2 rounded-2" href=https://e10v.me/tags/learning-to-rank/>learning to rank</a></small> <small><a class="bg-body-secondary py-1 px-2 rounded-2" href=https://e10v.me/tags/uplift-modelling/>uplift modelling</a></small> <small><a class="bg-body-secondary py-1 px-2 rounded-2" href=https://e10v.me/tags/choice-modelling/>choice modelling</a></small> <small><a class="bg-body-secondary py-1 px-2 rounded-2" href=https://e10v.me/tags/matching-market/>matching market</a></small><h2 class=h2 id=recap>Recap <a aria-label="Anchor link for: recap" class=anchor-link href=#recap>#</a></h2><p>This is the second post about the ranking problem in Profi, a services marketplace where customers can find tutors, beauty masters, plumbers, and other professionals, and professionals can find customers.<p>Here is the short recap of the <a href=https://e10v.me/ranking-two-sided-matching-platform-part-1/>previous post</a>:<ul><li>In Profi, professionals search, choose orders, and send proposals to customers. And then the customers review the proposals and choose the professionals, or don't choose anyone. If a professional sends a proposal to a customer, and the customer chooses the professional then this is a deal.<li>The objective was to increase the number of deals by implementing a new order ranking algorithm in the app for professionals.<li>Ranking orders by the probability of a proposal did increase the number of proposals, but didn't increase the number of deals in the marketplace.<li>Ranking orders by the uplift in the probability of a deal significantly increased the number of deals in the marketplace.</ul><figure class="figure text-center mx-auto d-block mb-4"><img alt="Uplift in the probability of a deal" class="figure-img img-fluid mb-0" src=https://e10v.me/ranking-two-sided-matching-platform-part-2/uplift_in_probability_of_deal.svg width=440px><figcaption class=figure-caption><p>Uplift in the probability of a deal</p></figcaption></figure><p>In the second post, I'll explain the solution. This post is more mathematical. Please bear with me while I go through some details of the model.<h2 class=h2 id=mathematical-formulation>Mathematical formulation <a aria-label="Anchor link for: mathematical-formulation" class=anchor-link href=#mathematical-formulation>#</a></h2><p>First, let's express the uplift in the probability of a deal in a mathematical form:<p>$$P(Y_i = 1 \mid S_{ij} = 1) - P(Y_i = 1 \mid S_{ij} = 0)$$<ul><li>$Y_i$ is an outcome for the order $i$. If there is a deal, then $Y_i = 1$, otherwise $Y_i = 0$.<li>$S_{ij}$ indicates whether the professional $j$ has seen the order $i$ or not.<li>$P(Y_i = 1 \mid S_{ij} = 1)$ is the probability of a deal in the order $i$, given that the professional $j$ has seen the order.<li>$P(Y_i = 1 \mid S_{ij} = 0)$ is the probability of a deal in the order $i$, given that the professional $j$ hasn't seen the order.</ul><p>It seems impossible to solve this problem directly. Hundreds of professionals should see the order for a deal to happen. Estimating the effect of showing an order to a professional would be very noisy.<p>Let's decompose the problem by expanding the expression using the law of total probability:<p>$$P(T_{ij} = 1 \mid S_{ij} = 1)(P(Y_i = 1 \mid T_{ij} = 1) - P(Y_i = 1 \mid T_{ij} = 0))$$<ul><li>$T_{ij}$ indicates whether the professional $j$ has sent a proposal to the customer $i$ or not.<li>$P(T_{ij} = 1 \mid S_{ij} = 1)$ is the probability that the professional $j$ will send a proposal to the customer $i$, given that the professional has seen the order.<li>$P(Y_i = 1 \mid T_{ij} = 1)$ is the probability of a deal in the order $i$, given that the professional $j$ has sent a proposal to the customer.<li>$P(Y_i = 1 \mid T_{ij} = 0)$ is the probability of a deal in the order $i$, given that the professional $j$ hasn't sent a proposal to the customer.</ul><div class="accordion mb-3"><div class=accordion-item><p class=accordion-header><a class="d-flex collapsed" aria-controls=myid aria-expanded=false data-bs-toggle=collapse href=#uplift-derivation role=button> Derivation <svg class="bi ms-auto" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><use href=https://e10v.me/icons.svg#chevron-down></use></svg> </a><div class="accordion-collapse collapse" id=uplift-derivation><div class=accordion-body><p>Let's expand the left and the right part of the uplift expression:<p>$$ \small \begin{split} P(Y_i = 1 \mid S_{ij} = 1) & = P(Y_i = 1 \mid T_{ij} = 1)P(T_{ij} = 1 \mid S_{ij} = 1) \\ & \quad + P(Y_i = 1 \mid T_{ij} = 0)P(T_{ij} = 0 \mid S_{ij} = 1) \\ & = P(Y_i = 1 \mid T_{ij} = 1)P(T_{ij} = 1 \mid S_{ij} = 1) \\ & \quad + P(Y_i = 1 \mid T_{ij} = 0)(1 - P(T_{ij} = 1 \mid S_{ij} = 1)) \\ & = P(T_{ij} = 1 \mid S_{ij} = 1)(P(Y_i = 1 \mid T_{ij} = 1) - P(Y_i = 1 \mid T_{ij} = 0)) \\ & \quad + P(Y_i = 1 \mid T_{ij} = 0) \\ \\ P(Y_i = 1 \mid S_{ij} = 0) & = P(Y_i = 1 \mid T_{ij} = 1)P(T_{ij} = 1 \mid S_{ij} = 0) \\ & \quad + P(Y_i = 1 \mid T_{ij} = 0)P(T_{ij} = 0 \mid S_{ij} = 0) \\ & = P(Y_i = 1 \mid T_{ij} = 0) \\ \end{split} $$<p>The last equation takes into account that a professional cannot send a proposal without seeing the order, i.e.:<p>$$ \small \begin{split} & P(T_{ij} = 1 \mid S_{ij} = 0) = 0 \\ & P(T_{ij} = 0 \mid S_{ij} = 0) = 1 \end{split} $$<p>Now, we can derive that:<p>$$ \small \begin{split} & P(Y_i = 1 \mid S_{ij} = 1) - P(Y_i = 1 \mid S_{ij} = 0) \\ = P(T_{ij} = 1 \mid S_{ij} = 1)(& P(Y_i = 1 \mid T_{ij} = 1) - P(Y_i = 1 \mid T_{ij} = 0)) \end{split} $$</div></div></div></div><p>We already have a <a href=https://e10v.me/ranking-two-sided-matching-platform-part-1/#probability-of-a-proposal>model</a> that predicts $P(T_{ij} = 1 \mid S_{ij} = 1)$, the probability that the professional $j$ will send a proposal to the customer $i$.<p>So, now the problem reduces to predicting the uplift in the probability of a deal caused by a proposal from the professional:<p>$$P(Y_i = 1 \mid T_{ij} = 1) - P(Y_i = 1 \mid T_{ij} = 0)$$<p>To solve the problem, we'll create a model for the probability of a deal in the order. The difference between the probabilities of a deal with and without a proposal from the professional is the uplift we want to predict.<h2 class=h2 id=discrete-choice-model>Discrete choice model <a aria-label="Anchor link for: discrete-choice-model" class=anchor-link href=#discrete-choice-model>#</a></h2><p>A customer can choose one of the professionals who sent a proposal, or not choose anyone.<p>Let's model customer's choice with the softmax function:<p>$$P(Y_{ik}=1) = \frac{e^{U_{ik}}}{e^{U_{i0}} + \sum_{j \in J_i} e^{U_{ij}}} = \frac{e^{U_{ik}-U_{i0}}}{1 + \sum_{j \in J_i} e^{U_{ij}-U_{i0}}}$$<ul><li>$Y_{ik}$ indicates whether the customer $i$ chooses the professional $k$ or not.<li>$P(Y_{ik}=1)$ is the probability that the customer $i$ will choose the professional $k$.<li>$U_{ij}$ (or $U_{ik}$) is the utility the customer $i$ obtains from choosing the professional $j$ (or $k$).<li>$U_{i0}$ is the utility the customer $i$ obtains from not choosing anyone.<li>$J_i$ is a set of professionals who sent a proposal to the customer $i$.</ul><p>This model assumes no correlation among alternatives. This might not be 100% true. But we decided to proceed with this model:<ul><li>Given that customers and professionals have unique preferences that only they can discover, this assumption seems realistic.<li>Taking into account the sequential number of the proposal in the order can capture correlations between proposals.</ul><p>Now, we can express the probability that the customer will choose one of the professionals who sent a proposal:<p>$$P(Y_i=1) = \sum_{j \in J_i} P(Y_{ij}=1) = \frac{\sum_{j \in J_i} e^{U_{ij}-U_{i0}}}{1 + \sum_{j \in J_i} e^{U_{ij}-U_{i0}}}$$<p>Suppose the customer $i$ has received proposals from a set of professionals $J_i$. Then the uplift in the probability of a deal caused by a proposal from the professional $k$ will be:<p>$$ \begin{split} & P(Y_i = 1 \mid T_{ik} = 1) - P(Y_i = 1 \mid T_{ik} = 0) \\ & = \frac{\sum_{j \in J_i} e^{U_{ij}-U_{i0}} + e^{U_{ik}-U_{i0}}}{1 + \sum_{j \in J_i} e^{U_{ij}-U_{i0}} + e^{U_{ik}-U_{i0}}} - \frac{\sum_{j \in J_i} e^{U_{ij}-U_{i0}}}{1 + \sum_{j \in J_i} e^{U_{ij}-U_{i0}}} \\ & = \frac{e^{U_{ik}-U_{i0}}}{(1 + \sum_{j \in J_i} e^{U_{ij}-U_{i0}})(1 + \sum_{j \in J_i} e^{U_{ij}-U_{i0}} + e^{U_{ik}-U_{i0}})} \end{split} $$<p>If we can model the utility, we can estimate the uplift in the probability of a deal.<h2 class=h2 id=utility-function>Utility function <a aria-label="Anchor link for: utility-function" class=anchor-link href=#utility-function>#</a></h2><p>The utility a customer obtains from choosing a professional depends on:<ul><li>How much time has passed from the moment of the order to the proposal from the professional.<li>The rating and the number of reviews in the professional's profile.<li>When the customer was last online.<li>And other factors.</ul><p>If we represent the utility as a function of these variables, then the parameters of the function can be estimated by minimizing the cross-entropy (maximum likelihood estimation):<p>$$ \begin{split} H(Y, P(Y)) & = -\sum_i (Y_i \log P(Y_i = 1) + (1 - Y_i) \log P(Y_i = 0)) \\ & = \sum_i (\log (1 + \sum_{j \in J_i} e^{U_{ij}-U_{i0}}) - Y_i \log (\sum_{j \in J_i} e^{U_{ij}-U_{i0}})) \end{split} $$<p>We started with a basic model that accounts only for how much time has passed from the moment of the order to the proposal from the professional. And this basic model helped us significantly increase the number of deals.<h2 class=h2 id=combined-target>Combined target <a aria-label="Anchor link for: combined-target" class=anchor-link href=#combined-target>#</a></h2><p>Let's review the components of the successful solution:<ul><li>A model $f(X_1)$ that takes a feature set $X_1$ and predicts the probability that the professional will send a proposal to the customer.<li>A model $g(X_2)$ that takes a feature set $X_2$ and predicts the uplift in the probability of a deal in the order caused by a proposal from the professional.<li>Orders are sorted by the product of these models' predictions $f(X_1) g(X_2)$.</ul><p>This solution has its disadvantages:<ul><li>Using two models in production increases the complexity of the solution.<li>The model $f(X_1)$ should predict the probability. This limits how the model can be improved. For example, the loss function is the cross-entropy. We cannot use loss functions that are more suitable for the learning to rank problem.</ul><p>These disadvantages can be resolved by training a model on a combined target. Instead of training a model $f(X_1)$ on an indicator of a proposal $y$, we can train a model $h(X_1, X_2)$ on a combined target $y g(X_2)$. This solution resulted in a further increase in the number of deals.<h2 class=h2 id=conclusions>Conclusions <a aria-label="Anchor link for: conclusions" class=anchor-link href=#conclusions>#</a></h2><p>In two posts I explored the ranking problem in a services marketplace. It's a two-sided matching platform where both sides have to choose each other for a deal to happen. I explained the solution that significantly increased the number of deals in the marketplace.<p>The right problem formulation is more important than a sophisticated solution. When one side searches and proposes, and the other side chooses among the proposals, it's not sufficient to maximize the probability of a proposal. Ranking by the uplift in the probability of a deal increased the number of deals in the marketplace.<p>When two sides choose, it makes sense to model two processes separately:<ul><li>Probability of a proposal from the side that chooses first.<li>Uplift in the probability of a match caused by a proposal.</ul><p>A discrete choice model can be used to estimate the uplift in the probability of a match.<p>If one of the models should predict the probability measure, it limits the model improvements. Training a single model on a combined target can resolve this issue.<p class=my-4>© Evgeny Ivanov 2023</article></main><footer><p class=my-4>Follow me on:<a class="link-body-emphasis ms-2" href=https://www.linkedin.com/in/evgenyivanov target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><use href=/icons.svg#linkedin></use></svg> <span class=d-sm-none>LinkedIn</span> </a><a class="link-body-emphasis ms-2" href=https://x.com/e10v_me target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>X (Twitter)</title><use href=/icons.svg#twitter-x></use></svg> <span class=d-sm-none>X (Twitter)</span> </a><a class="link-body-emphasis ms-2" href=https://bsky.app/profile/e10v.me target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>Bluesky</title><use href=/icons.svg#bluesky></use></svg> <span class=d-sm-none>Bluesky</span> </a><a class="link-body-emphasis ms-2" href=https://t.me/e10v_me target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>Telegram</title><use href=/icons.svg#telegram></use></svg> <span class=d-sm-none>Telegram</span> </a><a class="link-body-emphasis ms-2" href=/atom.xml target=_blank> <svg viewbox="0 0 16 16" class=bi fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><title>Atom</title><use href=/icons.svg#rss-fill></use></svg> <span class=d-sm-none>Atom</span> </a></footer><div id=comments><script async crossorigin data-category=Announcements data-category-id=DIC_kwDOKD9-Dc4CmKHr data-emit-metadata=0 data-input-position=bottom data-lang=en data-mapping=title data-reactions-enabled=1 data-repo=e10v/e10v.github.io data-repo-id=R_kgDOKD9-DQ data-strict=1 data-theme=preferred_color_scheme src=https://giscus.app/client.js></script></div></div><script crossorigin integrity=sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js></script><script crossorigin defer integrity=sha384-+W9OcrYK2/bD7BmUAk+xeFAyKp0QjyRQUCxeU31dfyTt/FrPsUgaBTLLkVf33qWt src=https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/katex.min.js></script><script crossorigin defer integrity=sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh onload=renderMathInElement(document.body); src=https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
              delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
              ]
            });
          });</script>